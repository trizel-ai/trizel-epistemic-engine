name: Phase-3 Analysis Validation

on:
  pull_request:

jobs:
  validate_phase3:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install minimal dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run Phase-3 unit tests (contract + smoke)
        run: |
          pytest -q \
            tests/test_phase3_smoke.py \
            tests/test_phase3_contract.py

      - name: Run deterministic Phase-3 analysis entrypoint
        env:
          GIT_SHORT_SHA: "ci00000"
        run: |
          python -m analysis.pipelines.run_analysis \
            --method-id noop \
            --input-scope states/3I_ATLAS \
            --run-id ci-test

      - name: Enforce output directory boundaries
        run: |
          python << 'PY'
          from pathlib import Path

          root = Path(".").resolve()
          allowed = {
              (root / "analysis_artifacts").resolve(),
              (root / "releases").resolve(),
          }

          created = []
          for p in root.rglob("*"):
              if ".git" in p.parts:
                  continue
              if p.is_file():
                  parent = p.parent.resolve()
                  if not any(str(parent).startswith(str(a)) for a in allowed):
                      continue
                  created.append(p)

          # Hard assertion: no outputs outside allowed dirs
          for p in created:
              if not any(str(p).startswith(str(a)) for a in allowed):
                  raise SystemExit(
                      f"Forbidden output path detected: {p}"
                  )

          print("Phase-3 output boundary check passed.")
          PY
