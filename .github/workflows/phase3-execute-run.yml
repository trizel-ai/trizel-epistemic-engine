name: Phase-3 Execute Declared Run

on:
  push:
    branches:
      - phase3/initialize-analytic-engine
  workflow_dispatch:

permissions:
  contents: write

jobs:
  execute_declared_run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest

      - name: Run Phase-3 tests
        run: |
          pytest -q tests/test_phase3_smoke.py tests/test_phase3_contract.py

      - name: Check execution flag
        id: gate
        run: |
          if [ -f analysis_artifacts/RUN_0002/EXECUTE_IN_CI.flag ]; then
            echo "execute=true" >> $GITHUB_OUTPUT
          else
            echo "execute=false" >> $GITHUB_OUTPUT
          fi

      - name: Execute RUN_0002
        if: steps.gate.outputs.execute == 'true'
        env:
          GIT_SHORT_SHA: ci00000
        run: |
          python -m analysis.pipelines.run_analysis \
            --run-id RUN_0002 \
            --method-id P3.M1.STATE_COVERAGE_AUDIT \
            --input-scope states/3I_ATLAS

      - name: Commit outputs
        if: steps.gate.outputs.execute == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add analysis_artifacts/RUN_0002/run_manifest.json analysis_artifacts/RUN_0002/summary.json

          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi

          git commit -m "Phase-3: Execute RUN_0002 via CI"
          git push
